<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bdsim.run_sim &mdash; Block diagram simulation  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Block diagram simulation
              <img src="../../_static/BDSimLogo_NoBackgnd@2x.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.1.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Code documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../bdsim.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bdsim.blocks.html">Block library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internals.html">Supporting classes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Block diagram simulation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">bdsim.run_sim</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for bdsim.run_sim</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">traceback</span> <span class="k">as</span> <span class="nn">tb</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">bdsim.blockdiagram</span> <span class="kn">import</span> <span class="n">BlockDiagram</span>
<span class="kn">from</span> <span class="nn">bdsim.components</span> <span class="kn">import</span> <span class="n">OptionsBase</span><span class="p">,</span> <span class="n">Block</span><span class="p">,</span> <span class="n">Clock</span><span class="p">,</span> <span class="n">BDStruct</span><span class="p">,</span> <span class="n">Plug</span><span class="p">,</span> <span class="n">clocklist</span>
<span class="kn">import</span> <span class="nn">spatialmath.base</span> <span class="k">as</span> <span class="nn">smb</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">webbrowser</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.integrate</span> <span class="k">as</span> <span class="nn">integrate</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">colored</span> <span class="kn">import</span> <span class="n">fg</span><span class="p">,</span> <span class="n">attr</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">progress.bar</span> <span class="kn">import</span> <span class="n">FillingCirclesBar</span>

    <span class="n">_FillingCirclesBar</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_FillingCirclesBar</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">Progress</span><span class="p">:</span>
    <span class="c1"># print a progress bar</span>
    <span class="c1"># https://stackoverflow.com/questions/3173320/text-progress-bar-in-the-console</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">printProgressBar</span><span class="p">(</span>
        <span class="n">fraction</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;â–ˆ&quot;</span><span class="p">,</span> <span class="n">printEnd</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span>
    <span class="p">):</span>
        <span class="n">percent</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;{0:.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decimals</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;f}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fraction</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">filledLength</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">length</span> <span class="o">*</span> <span class="n">fraction</span><span class="p">)</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">fill</span> <span class="o">*</span> <span class="n">filledLength</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">filledLength</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2"> |</span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="s2">| </span><span class="si">{</span><span class="n">percent</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">printEnd</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">enable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">60</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">enable</span><span class="p">:</span>
            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">T</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">_FillingCirclesBar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bar</span> <span class="o">=</span> <span class="n">FillingCirclesBar</span><span class="p">(</span>
                <span class="s2">&quot;bdsim&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(percent).1f%%</span><span class="s2"> - </span><span class="si">%(eta)d</span><span class="s2">s&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">printProgressBar</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;Progress:&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean up progress bar</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">_FillingCirclesBar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">+</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update progress bar</span>

<span class="sd">        :param t: current simulation time, defaults to None</span>
<span class="sd">        :type t: float, optional</span>

<span class="sd">        Update progress bar as a percentage of the maximum simulation time,</span>
<span class="sd">        given as an argument to ``run``.</span>

<span class="sd">        :seealso: :meth:`run` :meth:`progress_done`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">_FillingCirclesBar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bar</span><span class="o">.</span><span class="n">goto</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">printProgressBar</span><span class="p">(</span>
                <span class="n">t</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;Progress:&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span>
            <span class="p">)</span>


<span class="k">class</span> <span class="nc">TimeQ</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Time-ordered queue for events</span>

<span class="sd">    The list comprises tuples of (time, block) to reflect an event associated</span>
<span class="sd">    with the specified block at the specified time.</span>

<span class="sd">    The list is not ordered, and is sorted on a pop event.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Length of time-ordered queue</span>

<span class="sd">        :return: number of items in the queue</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String representation of time-ordered queue</span>

<span class="sd">        :return: show length and first item</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;TimeQ: len=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;TimeQ: len=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">, first out </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">:</span>
            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Push value onto time-ordered queue</span>

<span class="sd">        :param value: tuple (time, block)</span>
<span class="sd">        :type value: tuple</span>

<span class="sd">        Push a block and a time onto the queue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pop nearest items from the time-ordered queue</span>

<span class="sd">        :param dt: time window, defaults to 0</span>
<span class="sd">        :type dt: float, optional</span>
<span class="sd">        :return: time of first block in queue and a list of blocks within the time window</span>
<span class="sd">        :rtype: float, list</span>

<span class="sd">        The next block is popped from the queue and all blocks in the time</span>
<span class="sd">        window, that occur no more than ``dt`` later, are also popped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">qfirst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">qfirst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">qfirst</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="p">):</span>
            <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">blocks</span>

    <span class="k">def</span> <span class="nf">pop_until</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pop nearest items from time-ordered queue</span>

<span class="sd">        :param t: time</span>
<span class="sd">        :type t: float</span>
<span class="sd">        :return: list of blocks remaining sorted by receding time</span>
<span class="sd">        :rtype: list</span>

<span class="sd">        Pops all items with time less than or equal to ``t``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
                <span class="k">return</span> <span class="n">out</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="c1"># convert class name to BLOCK name</span>
<span class="c1"># strip underscores and capitalize</span>
<span class="k">def</span> <span class="nf">blockname</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>


<div class="viewcode-block" id="BDSimState">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSimState">[docs]</a>
<span class="k">class</span> <span class="nc">BDSimState</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :ivar x: state vector</span>
<span class="sd">    :vartype x: np.ndarray</span>
<span class="sd">    :ivar T: maximum simulation time (seconds)</span>
<span class="sd">    :vartype T: float</span>
<span class="sd">    :ivar t: current simulation time (seconds)</span>
<span class="sd">    :vartype t: float</span>
<span class="sd">    :ivar fignum: number of next matplotlib figure to create</span>
<span class="sd">    :vartype fignum: int</span>
<span class="sd">    :ivar stop: reference to block wanting to stop simulation, else None</span>
<span class="sd">    :vartype stop: Block subclass</span>
<span class="sd">    :ivar checkfinite: halt simulation if any wire has inf or nan</span>
<span class="sd">    :vartype checkfinite: bool</span>
<span class="sd">    :ivar graphics: enable graphics</span>
<span class="sd">    :vartype graphics: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="BDSimState.__init__">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSimState.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># continuous state vector numpy.ndarray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># maximum.BlockDiagram time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># current time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fignum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkfinite</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_stop</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># time-based breakpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventq</span> <span class="o">=</span> <span class="n">TimeQ</span><span class="p">()</span></div>


<div class="viewcode-block" id="BDSimState.declare_event">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSimState.declare_event">[docs]</a>
    <span class="k">def</span> <span class="nf">declare_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventq</span><span class="o">.</span><span class="n">push</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">block</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="BDSim">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim">[docs]</a>
<span class="k">class</span> <span class="nc">BDSim</span><span class="p">:</span>
    <span class="n">_blocklibrary</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="BDSim.__init__">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">banner</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">packages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">toolboxes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param banner: display docstring banner, defaults to True</span>
<span class="sd">        :type banner: bool, optional</span>
<span class="sd">        :param packages: colon-separated list of folders to search for blocks</span>
<span class="sd">        :type packages: str</span>
<span class="sd">        :param load: dynamically load blocks from libraries, defaults to True</span>
<span class="sd">        :type load: bool,optional</span>
<span class="sd">        :param sysargs: process options from sys.argv, defaults to True</span>
<span class="sd">        :type sysargs: bool, optional</span>
<span class="sd">        :param graphics: enable graphics, defaults to True</span>
<span class="sd">        :type graphics: bool, optional</span>
<span class="sd">        :param animation: enable animation, defaults to False</span>
<span class="sd">        :type animation: bool, optional</span>
<span class="sd">        :param progress: enable progress bar, defaults to True</span>
<span class="sd">        :type progress: bool, optional</span>
<span class="sd">        :param debug: debug options, defaults to None</span>
<span class="sd">        :type debug: str, optional</span>
<span class="sd">        :param backend: matplotlib backend, defaults to &#39;Qt5Agg&#39;&#39;</span>
<span class="sd">        :type backend: str, optional</span>
<span class="sd">        :param tiles: figure tile layout on monitor, defaults to &#39;3x4&#39;</span>
<span class="sd">        :type tiles: str, optional</span>
<span class="sd">        :raises ImportError: syntax error in block</span>
<span class="sd">        :return: parent object for blockdiagram simulation</span>
<span class="sd">        :rtype: BDSim</span>

<span class="sd">        If ``sysargs`` is True, process command line arguments and passed</span>
<span class="sd">        options.  Command line arguments have precedence.</span>

<span class="sd">        ===================  =========  ========  ===========================================</span>
<span class="sd">        Command line switch  Argument   Default   Behaviour</span>
<span class="sd">        ===================  =========  ========  ===========================================</span>
<span class="sd">        --graphics, +g       graphics   True      enable graphical display</span>
<span class="sd">        --animation, +a      animation  True      update graphics at each time step</span>
<span class="sd">        --hold, +h           hold       True      hold graphics in done()</span>
<span class="sd">        --no-graphics, -g    graphics   True      disable graphical display</span>
<span class="sd">        --no-animation, -a   animation  True      don&#39;t update graphics at each time step</span>
<span class="sd">        --no-hold, -H        hold       True      do not hold graphics in done()</span>
<span class="sd">        --no-progress, -p    progress   True      do not display simulation progress bar</span>
<span class="sd">        --backend BE         backend    &#39;Qt5Agg&#39;  matplotlib backend</span>
<span class="sd">        --tiles RxC, -t RxC  tiles      &#39;3x4&#39;     arrangement of figure tiles on the display</span>
<span class="sd">        --shape WxH          shape      None      window size, default matplotlib size</span>
<span class="sd">        --altscreen, +A,     altscreen  True      display plots on second monitor</span>
<span class="sd">        --no-altscreen, -A   altscreen  True      do not display plots on second monitor</span>
<span class="sd">        --debug F, -d F      debug      &#39;&#39;        debug flag string</span>
<span class="sd">        --simtime T[,dt]     simtime    (10,)     simulation time</span>
<span class="sd">        --verbose, -v        verbose    False     be verbose</span>
<span class="sd">        --quiet, -q          quiet      False     suppress reports</span>
<span class="sd">        -o                   outfile    None      output pickled simulation results to bd.out</span>
<span class="sd">        --out OUTFILE        outfile    None      file to save pickled simulation results</span>
<span class="sd">        --set P, -s P        setparam   []        override block parameter using ``P=block:param=value``</span>
<span class="sd">        --global G           setglob    []        override global parameter using ``G=var=value``</span>
<span class="sd">        ===================  =========  ========  ===========================================</span>

<span class="sd">        .. note:: ``animation`` and ``graphics`` options are coupled.  If</span>
<span class="sd">            ``graphics=False``, all graphics is suppressed.  If</span>
<span class="sd">            ``graphics=True`` then graphics are shown and the behaviour depends</span>
<span class="sd">            on ``animation``.  ``animation=False`` shows graphs at the end of</span>
<span class="sd">            the simulation, while ``animation=True` will animate the graphs</span>
<span class="sd">            during simulation.</span>

<span class="sd">        :seealso: :meth:`set_globals()`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">packages</span> <span class="o">=</span> <span class="n">packages</span>

        <span class="c1"># process command line and overall options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">Options</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># print docstring as a startup banner</span>
        <span class="k">if</span> <span class="n">banner</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">calling_frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">calling_frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s2">&quot;__doc__&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">doc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># load modules from the blocks folder</span>
        <span class="k">if</span> <span class="n">BDSim</span><span class="o">.</span><span class="n">_blocklibrary</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">load</span><span class="p">:</span>
            <span class="n">BDSim</span><span class="o">.</span><span class="n">_blocklibrary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_blocks</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">toolboxes</span><span class="o">=</span><span class="n">toolboxes</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">()</span></div>


<div class="viewcode-block" id="BDSim.blockinfo">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.blockinfo">[docs]</a>
    <span class="k">def</span> <span class="nf">blockinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return info about all blocks</span>

<span class="sd">        :param block: name of block to return info for, otherwise list of info for all</span>
<span class="sd">        :type block: str, optional</span>
<span class="sd">        :returns: parameters of blocks</span>
<span class="sd">        :rtype: dict or list of dicts</span>

<span class="sd">        Detailed metadata about a block is obtained by introspection and parsing the block&#39;s docstring.</span>

<span class="sd">        ==========   =====================================================</span>
<span class="sd">        Key          Description</span>
<span class="sd">        ==========   =====================================================</span>
<span class="sd">        path         Path to the folder containing block definition</span>
<span class="sd">        classname    Name of class</span>
<span class="sd">        url          URL of online documentation</span>
<span class="sd">        class        Reference to the class</span>
<span class="sd">        module       Name of the module  package.blocks.module</span>
<span class="sd">        package      Name of the package, eg. bdsim, roboticstoolbox</span>
<span class="sd">        params       Dict of (type, descrip), indexed by parameter name</span>
<span class="sd">        inputs       List of names of block inputs</span>
<span class="sd">        outputs      List of names of block outputs</span>
<span class="sd">        nin          Number of inputs, -1 if variable</span>
<span class="sd">        nout         Number of outputs, -1 if variable</span>
<span class="sd">        blockclass   Block class, eg. source, sink etc.</span>
<span class="sd">        ==========   =====================================================</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">block</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocklibrary</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocklibrary</span><span class="p">[</span><span class="n">block</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String representation of simulation</span>

<span class="sd">        :return: single line summary of simulation environment</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;BDSim: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocklibrary</span><span class="p">)</span><span class="si">}</span><span class="s2"> blocks in library</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Block diagram simulation runtime, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocklibrary</span><span class="p">)</span><span class="si">}</span><span class="s2"> blocks&quot;</span>
            <span class="s2">&quot; imported to library.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;simulation options:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  </span><span class="si">{:s}</span><span class="s2">: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

<div class="viewcode-block" id="BDSim.run">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bd</span><span class="p">,</span>
        <span class="n">T</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">dt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;RK45&quot;</span><span class="p">,</span>
        <span class="n">solver_args</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">debug</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">checkfinite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">minstepsize</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span>
        <span class="n">watch</span><span class="o">=</span><span class="p">[],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the block diagram</span>

<span class="sd">        :param T: maximum integration time, defaults to 10.0</span>
<span class="sd">        :type T: float, optional</span>
<span class="sd">        :param dt: maximum time step</span>
<span class="sd">        :type dt: float, optional</span>
<span class="sd">        :param solver: integration method, defaults to ``RK45``</span>
<span class="sd">        :type solver: str, optional</span>
<span class="sd">        :param block: matplotlib block at end of run, default False</span>
<span class="sd">        :type block: bool</span>
<span class="sd">        :param checkfinite: error if inf or nan on any wire, default True</span>
<span class="sd">        :type checkfinite: bool</span>
<span class="sd">        :param minstepsize: minimum step length, default 1e-6</span>
<span class="sd">        :type minstepsize: float</span>
<span class="sd">        :param watch: list of input ports to log</span>
<span class="sd">        :type watch: list</span>
<span class="sd">        :param solver_args: arguments passed to ``scipy.integrate``</span>
<span class="sd">        :type solver_args: dict</span>
<span class="sd">        :return: time history of signals and states</span>
<span class="sd">        :rtype: Sim class</span>

<span class="sd">        Assumes that the network has been compiled.</span>

<span class="sd">        The system is simulated from time 0 to ``T``.</span>

<span class="sd">        The integration step time ``dt`` defaults to ``T/100`` but can be</span>
<span class="sd">        specified.  Finer control can be achieved using ``max_step`` and</span>
<span class="sd">        ``first_step`` parameters to the underlying integrator using the</span>
<span class="sd">        ``solver_args`` parameter.</span>

<span class="sd">        Results are returned in a class with attributes:</span>

<span class="sd">        - ``t`` the time vector: ndarray, shape=(M,)</span>
<span class="sd">        - ``x`` is the state vector: ndarray, shape=(M,N)</span>
<span class="sd">        - ``xnames`` is a list of the names of the states corresponding to columns of `x`, eg. &quot;plant.x0&quot;,</span>
<span class="sd">            defined for the block using the ``snames`` argument</span>
<span class="sd">        - ``yN`` for a watched input where N is the index of the port mentioned in the ``watch`` argument</span>
<span class="sd">        - ``ynames`` is a list of the names of the input ports being watched, same order as in ``watch`` argument</span>

<span class="sd">        If there are no dynamic elements in the diagram, ie. no states, then ``x`` and ``xnames`` are not</span>
<span class="sd">        present.</span>

<span class="sd">        The ``watch`` argument is a list of one or more input ports whose value during simulation</span>
<span class="sd">        will be recorded.  The elements of the list can be:</span>
<span class="sd">            - a ``Block`` reference, which is interpretted as input port 0</span>
<span class="sd">            - a ``Plug`` reference, ie. a block with an index or attribute</span>
<span class="sd">            - a string of the form &quot;block[i]&quot; which is port i of the block named block.</span>

<span class="sd">        The debug string comprises single letter flags:</span>

<span class="sd">                - &#39;p&#39; debug network value propagation</span>
<span class="sd">                - &#39;s&#39; debug state vector</span>
<span class="sd">                - &#39;d&#39; debug state derivative</span>

<span class="sd">        .. note:: Simulation stops if the step time falls below ``minsteplength``</span>
<span class="sd">            which typically indicates that the solver is struggling with a very</span>
<span class="sd">            harsh non-linearity.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">bd</span><span class="o">.</span><span class="n">compiled</span><span class="p">,</span> <span class="s2">&quot;Network has not been compiled&quot;</span>

        <span class="c1"># get simulation time</span>
        <span class="c1">#  --simtime=T  or --simtime=T,dt</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">default_times</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simtime</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_times</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                    <span class="n">T</span> <span class="o">=</span> <span class="n">default_times</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_times</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">T</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">default_times</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;bad simtime option passed &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simtime</span>
                    <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bad simtime option passed &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simtime</span><span class="p">)</span>

        <span class="c1"># final default values</span>
        <span class="c1"># T = T or 5</span>
        <span class="c1"># dt = dt or 0.01</span>

        <span class="n">simstate</span> <span class="o">=</span> <span class="n">BDSimState</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simstate</span> <span class="o">=</span> <span class="n">simstate</span>
        <span class="n">simstate</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">T</span>

        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">&quot;max_step&quot;</span> <span class="ow">in</span> <span class="n">solver_args</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">simstate</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="n">simstate</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">simstate</span><span class="o">.</span><span class="n">bdtime</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">simstate</span><span class="o">.</span><span class="n">gtime</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># last graphics update</span>
        <span class="n">simstate</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="n">simstate</span><span class="o">.</span><span class="n">solver_args</span> <span class="o">=</span> <span class="n">solver_args</span>
        <span class="n">simstate</span><span class="o">.</span><span class="n">minstepsize</span> <span class="o">=</span> <span class="n">minstepsize</span>
        <span class="n">simstate</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># allow any block to stop.BlockDiagram by setting this to the block&#39;s name</span>
        <span class="n">simstate</span><span class="o">.</span><span class="n">checkfinite</span> <span class="o">=</span> <span class="n">checkfinite</span>
        <span class="c1"># state.options = copy.copy(self.options)</span>
        <span class="n">simstate</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bd</span> <span class="o">=</span> <span class="n">bd</span>
        <span class="n">simstate</span><span class="o">.</span><span class="n">t_stop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="c1"># append debug flags</span>
            <span class="k">if</span> <span class="n">debug</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">simstate</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="n">simstate</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">debug</span> <span class="o">+=</span> <span class="n">debug</span>

        <span class="c1"># turn off progress bar if any debug options are given</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">simstate</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">block</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">hold</span> <span class="o">=</span> <span class="n">block</span>

        <span class="c1"># process the watchlist</span>
        <span class="c1">#  elements can be:</span>
        <span class="c1">#   - block or Plug reference</span>
        <span class="c1">#   - str in the form BLOCKNAME[PORT]</span>
        <span class="n">watchlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">watchnamelist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">re_block</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?P&lt;name&gt;[^[]+)(\[(?P&lt;port&gt;[0-9]+)\])?&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">watch</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="c1"># a name was given, with optional port number</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">re_block</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;watch block[port] not found: &quot;</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>

                <span class="c1"># get optional port number</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;port&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>

                <span class="n">b</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">blocknames</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">plug</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">port</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">Block</span><span class="p">):</span>
                <span class="c1"># a block was given, defaults to port 0</span>
                <span class="n">plug</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">Plug</span><span class="p">):</span>
                <span class="c1"># a plug was given</span>
                <span class="n">plug</span> <span class="o">=</span> <span class="n">w</span>
            <span class="n">watchlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plug</span><span class="p">)</span>
            <span class="n">watchnamelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">plug</span><span class="p">))</span>
        <span class="n">simstate</span><span class="o">.</span><span class="n">watchlist</span> <span class="o">=</span> <span class="n">watchlist</span>
        <span class="n">simstate</span><span class="o">.</span><span class="n">watchnamelist</span> <span class="o">=</span> <span class="n">watchnamelist</span>

        <span class="n">x0</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">getstate0</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">fg</span><span class="p">(</span><span class="s2">&quot;yellow&quot;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; Start simulation: T = </span><span class="si">{</span><span class="n">T</span><span class="si">}</span><span class="s2">, dt = </span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Continuous state variables: </span><span class="si">{</span><span class="n">bd</span><span class="o">.</span><span class="n">nstates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     x0 = &quot;</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Discrete state variables:   </span><span class="si">{</span><span class="n">bd</span><span class="o">.</span><span class="n">ndstates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># get the number of discrete states from all clocks</span>
        <span class="n">ndstates</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">clock</span> <span class="ow">in</span> <span class="n">bd</span><span class="o">.</span><span class="n">clocklist</span><span class="p">:</span>
            <span class="n">nds</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">clock</span><span class="o">.</span><span class="n">blocklist</span><span class="p">:</span>
                <span class="n">nds</span> <span class="o">+=</span> <span class="n">b</span><span class="o">.</span><span class="n">ndstates</span>
            <span class="n">ndstates</span> <span class="o">+=</span> <span class="n">nds</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">clock</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: x0 = &quot;</span><span class="p">,</span> <span class="n">clock</span><span class="o">.</span><span class="n">getstate0</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">attr</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># update block parameters given on command line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">(</span><span class="n">bd</span><span class="p">)</span>

        <span class="c1"># tell all blocks we&#39;re starting a BlockDiagram</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bd</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">simstate</span><span class="p">)</span>

        <span class="c1"># initialize list of time and states</span>
        <span class="n">simstate</span><span class="o">.</span><span class="n">tlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">simstate</span><span class="o">.</span><span class="n">xlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">simstate</span><span class="o">.</span><span class="n">plist</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">simstate</span><span class="o">.</span><span class="n">watchlist</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">Progress</span><span class="p">(</span><span class="n">enable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">simstate</span><span class="o">.</span><span class="n">eventq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># no simulation events, solve it in one go</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_interval</span><span class="p">(</span><span class="n">bd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">simstate</span><span class="o">=</span><span class="n">simstate</span><span class="p">)</span>
            <span class="n">nintervals</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># we have simulation events, solve it in chunks</span>
            <span class="n">simstate</span><span class="o">.</span><span class="n">declare_event</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>  <span class="c1"># add an event at end of simulation</span>

            <span class="c1"># ignore all the events at zero</span>
            <span class="n">tprev</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">simstate</span><span class="o">.</span><span class="n">eventq</span><span class="o">.</span><span class="n">pop_until</span><span class="p">(</span><span class="n">tprev</span><span class="p">)</span>

            <span class="c1"># get the state vector</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>

            <span class="n">nintervals</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># get next event from the queue and the list of blocks or</span>
                <span class="c1"># clocks at that time</span>
                <span class="n">tnext</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="n">simstate</span><span class="o">.</span><span class="n">eventq</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tnext</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="c1"># run system until next event time</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_interval</span><span class="p">(</span><span class="n">bd</span><span class="p">,</span> <span class="n">tprev</span><span class="p">,</span> <span class="n">tnext</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">simstate</span><span class="o">=</span><span class="n">simstate</span><span class="p">)</span>
                <span class="n">nintervals</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># visit all the blocks and clocks that have an event now</span>
                <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">Clock</span><span class="p">):</span>
                        <span class="c1"># clock ticked, save its state</span>
                        <span class="n">source</span><span class="o">.</span><span class="n">savestate</span><span class="p">(</span><span class="n">tnext</span><span class="p">)</span>
                        <span class="n">source</span><span class="o">.</span><span class="n">next_event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simstate</span><span class="p">)</span>

                        <span class="c1"># get the new state</span>
                        <span class="n">source</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">getstate</span><span class="p">(</span><span class="n">tnext</span><span class="p">)</span>
                <span class="n">tprev</span> <span class="o">=</span> <span class="n">tnext</span>

                <span class="c1"># are we done?</span>
                <span class="k">if</span> <span class="n">simstate</span><span class="o">.</span><span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">simstate</span><span class="o">.</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">T</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="c1"># finished integration</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>  <span class="c1"># cleanup the progress bar</span>

        <span class="c1"># print some info about the integration</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">fg</span><span class="p">(</span><span class="s2">&quot;yellow&quot;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;&lt; Simulation complete&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  block diagram evaluations: </span><span class="si">{</span><span class="n">simstate</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;  block diagram exec time:  &quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">simstate</span><span class="o">.</span><span class="n">bdtime</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">simstate</span><span class="o">.</span><span class="n">count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000.0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> ms&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  time steps:                </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">simstate</span><span class="o">.</span><span class="n">tlist</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  integration intervals:     </span><span class="si">{</span><span class="n">nintervals</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">attr</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># save buffered data in a Struct</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">BDStruct</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;results&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">simstate</span><span class="o">.</span><span class="n">tlist</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">simstate</span><span class="o">.</span><span class="n">xlist</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">xnames</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">statenames</span>

        <span class="c1"># save clocked states</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bd</span><span class="o">.</span><span class="n">clocklist</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">clockdata</span> <span class="o">=</span> <span class="n">BDStruct</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">clockdata</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
            <span class="n">clockdata</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">clockdata</span><span class="p">)</span>

        <span class="c1"># save the watchlist into variables named y0, y1 etc.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">watchlist</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;y&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">simstate</span><span class="o">.</span><span class="n">plist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">out</span><span class="o">.</span><span class="n">ynames</span> <span class="o">=</span> <span class="n">watchnamelist</span>

        <span class="c1"># the command line options -o or --out saves results as a pickle file</span>
        <span class="c1">#  -o defaults to bd.out</span>
        <span class="c1">#  --out FILE allows the filename to be specified</span>
        <span class="c1">#</span>
        <span class="c1"># we can visualize the output file by</span>
        <span class="c1">#</span>
        <span class="c1">#   % python -mpickle bd.out</span>
        <span class="c1">#   t      = ndarray:float64 (123,)</span>
        <span class="c1">#   x      = ndarray:float64 (123, 1)</span>
        <span class="c1">#   xnames = [&#39;plantx0&#39;] (list)</span>
        <span class="c1">#   ynames = [] (list)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">outfile</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;simulation results pickled --&gt; &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">outfile</span><span class="p">)</span>

        <span class="c1"># pause until all graphics blocks close</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">graphics</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">hold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bd</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">hold</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="BDSim.update_parameters">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.update_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">update_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set value of parameters according to command line arguments</span>

<span class="sd">        Command line arguments of the form:</span>

<span class="sd">            ``-s block:param=value``</span>
<span class="sd">            ``--set block:param=value``</span>

<span class="sd">        are stored as list items in ``options.setparam``</span>

<span class="sd">        ``block`` can be either:</span>

<span class="sd">        - the block&#39;s name as a string, either user assigned or bdsim assigned</span>
<span class="sd">        - the block ``id`` as displayed by the ``report`` method</span>

<span class="sd">        ``param`` is the name of the parameter used in the constructor</span>

<span class="sd">        ``value`` is the new value of the variable</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">re_set</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?P&lt;block&gt;[\w\.]+):(?P&lt;param&gt;[\w]+)=(?P&lt;value&gt;.*)&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">setparam</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re_set</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bad set parameter: &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>

            <span class="c1"># get block reference</span>
            <span class="n">blockname</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;block&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">blockname</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">blockname</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">bd</span><span class="p">[</span><span class="n">blockname</span><span class="p">]</span>

            <span class="n">param</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;param&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">prev_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;block </span><span class="si">{</span><span class="n">block</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has no parameter &#39;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="c1"># get the parameter</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;;&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">new_value</span> <span class="o">=</span> <span class="n">smb</span><span class="o">.</span><span class="n">str2array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">new_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot parse value &quot;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>

            <span class="c1"># change the value</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;changed value of </span><span class="si">{</span><span class="n">block</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">prev_value</span><span class="si">}</span><span class="s2"> -&gt;&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">new_value</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="BDSim.run_interval">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.run_interval">[docs]</a>
    <span class="k">def</span> <span class="nf">run_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">simstate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Integrate system over interval</span>

<span class="sd">        :param bd: the system blockdiagram</span>
<span class="sd">        :type bd: BlockDiagram</span>
<span class="sd">        :param t0: initial time</span>
<span class="sd">        :type t0: float</span>
<span class="sd">        :param tf: final time</span>
<span class="sd">        :type tf: float</span>
<span class="sd">        :param x0: initial state vector</span>
<span class="sd">        :type x0: ndarray(n)</span>
<span class="sd">        :param simstate: simulation state object</span>
<span class="sd">        :type simstate: SimState</span>
<span class="sd">        :return: final state vector xf</span>
<span class="sd">        :rtype: ndarray(n)</span>

<span class="sd">        The system is integrated from from ``x0`` to ``xf`` over the interval ``t0`` to ``tf``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bd</span><span class="o">.</span><span class="n">nstates</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># system has continuous states, solve it using numerical integration</span>
                <span class="c1"># print(&#39;initial state x0 = &#39;, x0)</span>

                <span class="c1"># block diagram contains states, solve it using numerical integration</span>

                <span class="n">scipy_integrator</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span>
                    <span class="n">simstate</span><span class="o">.</span><span class="n">solver</span>
                <span class="p">]</span>  <span class="c1"># get user specified integrator</span>

                <span class="k">def</span> <span class="nf">ydot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                    <span class="n">simstate</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>
                    <span class="n">simstate</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">yd</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">schedule_evaluate</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sinks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">simstate</span><span class="o">=</span><span class="n">simstate</span><span class="p">)</span>
                    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">simstate</span><span class="o">.</span><span class="n">bdtime</span> <span class="o">+=</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span>
                    <span class="k">return</span> <span class="n">yd</span>

                <span class="k">if</span> <span class="n">simstate</span><span class="o">.</span><span class="n">dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">simstate</span><span class="o">.</span><span class="n">solver_args</span><span class="p">[</span><span class="s2">&quot;max_step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simstate</span><span class="o">.</span><span class="n">dt</span>

                <span class="c1"># print(f&quot;run interval: from {t0} to {t0+T}, args={state.solver_args}, x0={x0}&quot;)</span>
                <span class="n">integrator</span> <span class="o">=</span> <span class="n">scipy_integrator</span><span class="p">(</span>
                    <span class="n">ydot</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">t_bound</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="o">**</span><span class="n">simstate</span><span class="o">.</span><span class="n">solver_args</span>
                <span class="p">)</span>

                <span class="c1"># integrate</span>
                <span class="k">while</span> <span class="n">integrator</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span>
                    <span class="c1"># step the integrator, calls _deriv and evaluate block diagram multiple times</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">integrator</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">integrator</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="n">fg</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
                            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">integration completed with failed status: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="o">+</span> <span class="n">attr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">break</span>

                    <span class="c1"># stash the results</span>
                    <span class="n">simstate</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">integrator</span><span class="o">.</span><span class="n">t</span>
                    <span class="n">simstate</span><span class="o">.</span><span class="n">tlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">integrator</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">simstate</span><span class="o">.</span><span class="n">xlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">integrator</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

                    <span class="c1"># record the ports on the watchlist</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">simstate</span><span class="o">.</span><span class="n">watchlist</span><span class="p">):</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">block</span>
                        <span class="n">out</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">integrator</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">_x</span><span class="p">)[</span><span class="n">p</span><span class="o">.</span><span class="n">port</span><span class="p">]</span>
                        <span class="n">simstate</span><span class="o">.</span><span class="n">plist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

                    <span class="c1"># update all blocks that need to know</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">integrator</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="n">simstate</span><span class="o">.</span><span class="n">gtime</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">simstate</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="mi">200</span><span class="p">):</span>
                        <span class="n">bd</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">integrator</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
                        <span class="n">simstate</span><span class="o">.</span><span class="n">gtime</span> <span class="o">=</span> <span class="n">integrator</span><span class="o">.</span><span class="n">t</span>
                    <span class="c1"># bd.step(integrator.t)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">simstate</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># update the progress bar</span>

                    <span class="k">if</span> <span class="n">integrator</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;finished&quot;</span><span class="p">:</span>
                        <span class="k">break</span>

                    <span class="c1"># has any block called a stop?</span>
                    <span class="k">if</span> <span class="n">simstate</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="n">fg</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- stop requested at t=</span><span class="si">{</span><span class="n">simstate</span><span class="o">.</span><span class="n">t</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> by&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">simstate</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">attr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">break</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">simstate</span><span class="o">.</span><span class="n">minstepsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="n">integrator</span><span class="o">.</span><span class="n">step_size</span> <span class="o">&lt;</span> <span class="n">simstate</span><span class="o">.</span><span class="n">minstepsize</span>
                    <span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="n">fg</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- stopping on minimum step size at&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot; t=</span><span class="si">{</span><span class="n">simstate</span><span class="o">.</span><span class="n">t</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> with last stepsize&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">integrator</span><span class="o">.</span><span class="n">step_size</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">attr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">break</span>

                    <span class="k">if</span> <span class="s2">&quot;i&quot;</span> <span class="ow">in</span> <span class="n">simstate</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="n">bd</span><span class="o">.</span><span class="n">_debugger</span><span class="p">(</span><span class="n">simstate</span><span class="p">,</span> <span class="n">integrator</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">integrator</span><span class="o">.</span><span class="n">y</span>  <span class="c1"># return final state vector</span>

            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">clocklist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># block diagram has no continuous or discrete states</span>

                <span class="k">assert</span> <span class="n">simstate</span><span class="o">.</span><span class="n">dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;if no states must specify dt&quot;</span>

                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">simstate</span><span class="o">.</span><span class="n">dt</span><span class="p">):</span>  <span class="c1"># step through the time range</span>
                    <span class="c1"># evaluate the block diagram</span>
                    <span class="n">simstate</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>

                    <span class="n">simstate</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">bd</span><span class="o">.</span><span class="n">schedule_evaluate</span><span class="p">([],</span> <span class="n">t</span><span class="p">)</span>
                    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">simstate</span><span class="o">.</span><span class="n">bdtime</span> <span class="o">+=</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span>

                    <span class="c1"># stash the results</span>
                    <span class="n">simstate</span><span class="o">.</span><span class="n">tlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

                    <span class="c1"># record the ports on the watchlist</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">simstate</span><span class="o">.</span><span class="n">watchlist</span><span class="p">):</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">block</span>
                        <span class="n">out</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">integrator</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">_x</span><span class="p">)[</span><span class="n">p</span><span class="o">.</span><span class="n">port</span><span class="p">]</span>
                        <span class="n">simstate</span><span class="o">.</span><span class="n">plist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

                    <span class="c1"># update all blocks that need to know</span>
                    <span class="n">bd</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># update the progress bar</span>

                    <span class="c1"># has any block called a stop?</span>
                    <span class="k">if</span> <span class="n">simstate</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="n">fg</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- stop requested at t=</span><span class="si">{</span><span class="n">simstate</span><span class="o">.</span><span class="n">t</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> by&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">simstate</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">attr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">break</span>

                    <span class="k">if</span> <span class="s2">&quot;i&quot;</span> <span class="ow">in</span> <span class="n">simstate</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="n">bd</span><span class="o">.</span><span class="n">_debugger</span><span class="p">(</span><span class="n">simstate</span><span class="p">,</span> <span class="n">integrator</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># block diagram has no continuous states</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t0</span>
                <span class="n">simstate</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>
                <span class="c1"># evaluate the block diagram</span>

                <span class="n">simstate</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">bd</span><span class="o">.</span><span class="n">schedule_evaluate</span><span class="p">([],</span> <span class="n">t</span><span class="p">)</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">simstate</span><span class="o">.</span><span class="n">bdtime</span> <span class="o">+=</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span>

                <span class="c1"># stash the results</span>
                <span class="n">simstate</span><span class="o">.</span><span class="n">tlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

                <span class="c1"># record the ports on the watchlist</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">simstate</span><span class="o">.</span><span class="n">watchlist</span><span class="p">):</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">block</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">integrator</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">_x</span><span class="p">)[</span><span class="n">p</span><span class="o">.</span><span class="n">port</span><span class="p">]</span>
                    <span class="n">simstate</span><span class="o">.</span><span class="n">plist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

                <span class="c1"># update all blocks that need to know</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">simstate</span><span class="o">.</span><span class="n">gtime</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">simstate</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="mi">200</span><span class="p">):</span>
                    <span class="n">bd</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">simstate</span><span class="o">.</span><span class="n">gtime</span> <span class="o">=</span> <span class="n">t</span>
                <span class="c1"># bd.step(t)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">simstate</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># update the progress bar</span>

                <span class="c1"># has any block called a stop?</span>
                <span class="k">if</span> <span class="n">simstate</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="n">fg</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- stop requested at t=</span><span class="si">{</span><span class="n">simstate</span><span class="o">.</span><span class="n">t</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> by&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">simstate</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">attr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;i&quot;</span> <span class="ow">in</span> <span class="n">simstate</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">bd</span><span class="o">.</span><span class="n">_debugger</span><span class="p">(</span><span class="n">simstate</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># bad things happens, print a message and return no result</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unrecoverable error in evaluation: &quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="BDSim.blockdiagram">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.blockdiagram">[docs]</a>
    <span class="k">def</span> <span class="nf">blockdiagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockDiagram</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiate a new block diagram object.</span>

<span class="sd">        :param name: diagram name, defaults to &#39;main&#39;</span>
<span class="sd">        :type name: str, optional</span>
<span class="sd">        :return: parent object for blockdiagram</span>
<span class="sd">        :rtype: BlockDiagram</span>

<span class="sd">        This object describes the connectivity of a set of blocks and wires.</span>

<span class="sd">        It is an instantiation of the ``BlockDiagram`` class with a factory</span>
<span class="sd">        method for every dynamically loaded block which returns</span>
<span class="sd">        an instance of the block.  These factory methods have names</span>
<span class="sd">        which are all upper case, for example, the method ``.GAIN`` invokes</span>
<span class="sd">        the constructor for the ``Gain`` class.</span>

<span class="sd">        :seealso: :func:`BlockDiagram`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># instantiate a new blockdiagram</span>
        <span class="n">bd</span> <span class="o">=</span> <span class="n">BlockDiagram</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">new_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">bd</span><span class="p">):</span>
            <span class="c1"># return a wrapper for the block constructor that automatically</span>
            <span class="c1"># adds the block to the diagram&#39;s blocklist</span>
            <span class="k">def</span> <span class="nf">block_init_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">block</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">bd</span><span class="o">=</span><span class="n">bd</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># call __init__ on the block</span>
                <span class="k">return</span> <span class="n">block</span>

            <span class="c1"># return a function that invokes the class constructor</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">block_init_wrapper</span>

            <span class="c1"># move the __init__ docstring to the class to allow BLOCK.__doc__</span>
            <span class="n">f</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__doc__</span>

            <span class="k">return</span> <span class="n">f</span>

        <span class="c1"># bind the block constructors as new methods on this instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">blockname</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocklibrary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># create a function to invoke the block&#39;s constructor</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">new_method</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">],</span> <span class="n">bd</span><span class="p">)</span>

            <span class="c1"># set a bound version of this function as an attribute of the instance</span>
            <span class="c1"># method = types.MethodType(new_method, bd)</span>
            <span class="c1"># setattr(bd, block.name, method)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">bd</span><span class="p">,</span> <span class="n">blockname</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="c1"># add a clone of the options</span>
        <span class="c1"># bd.options = copy.copy(self.options)</span>
        <span class="n">bd</span><span class="o">.</span><span class="n">runtime</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="n">bd</span></div>


<div class="viewcode-block" id="BDSim.DEBUG">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.DEBUG">[docs]</a>
    <span class="k">def</span> <span class="nf">DEBUG</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG.</span><span class="si">{</span><span class="n">debug</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span></div>


<div class="viewcode-block" id="BDSim.done">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.done">[docs]</a>
    <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">hold</span><span class="p">:</span>
            <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">hold</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bdsim: closing all windows&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
            <span class="c1"># sys.exit(1)  # not sure why we have this</span>
            <span class="k">return</span>
        <span class="n">bd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># let the event handler do its work</span></div>


<div class="viewcode-block" id="BDSim.closefigs">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.closefigs">[docs]</a>
    <span class="k">def</span> <span class="nf">closefigs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simstate</span><span class="o">.</span><span class="n">fignum</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simstate</span><span class="o">.</span><span class="n">fignum</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># reset figure counter</span></div>


<div class="viewcode-block" id="BDSim.savefig">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.savefig">[docs]</a>
    <span class="k">def</span> <span class="nf">savefig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">block</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="BDSim.savefigs">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.savefigs">[docs]</a>
    <span class="k">def</span> <span class="nf">savefigs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">bdsim.graphics</span> <span class="kn">import</span> <span class="n">GraphicsBlock</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bd</span><span class="o">.</span><span class="n">blocklist</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">GraphicsBlock</span><span class="p">):</span>
                <span class="n">b</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="BDSim.showgraph">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.showgraph">[docs]</a>
    <span class="k">def</span> <span class="nf">showgraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># create the temporary dotfile</span>
        <span class="n">dotfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">bd</span><span class="o">.</span><span class="n">dotfile</span><span class="p">(</span><span class="n">dotfile</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># rewind the dot file, create PDF file in the filesystem, run dot</span>
        <span class="n">dotfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pdffile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.pdf&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;dot -Tpdf&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">dotfile</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">pdffile</span><span class="p">)</span>

        <span class="c1"># open the PDF file in browser (hopefully portable), then cleanup</span>
        <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file://</span><span class="si">{</span><span class="n">pdffile</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pdffile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="BDSim.fatal">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.fatal">[docs]</a>
    <span class="k">def</span> <span class="nf">fatal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">retval</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fatal simulation error</span>

<span class="sd">        :param message: Error message</span>
<span class="sd">        :type message: str</span>
<span class="sd">        :param retval: system return value (*nix only) defaults to 1</span>
<span class="sd">        :type retval: int, optional</span>

<span class="sd">        Display the error message then terminate the process.  For operating</span>
<span class="sd">        systems that support it, return an integer code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO print text in some color</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span></div>


<div class="viewcode-block" id="BDSim.load_blocks">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.load_blocks">[docs]</a>
    <span class="k">def</span> <span class="nf">load_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">toolboxes</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dynamically load all block definitions.</span>

<span class="sd">        :raises ImportError: module could not be imported</span>
<span class="sd">        :return: dictionary of block metadata</span>
<span class="sd">        :rtype: dict of dict</span>

<span class="sd">        Reads blocks from .py files found in bdsim/bdsim/blocks, folders</span>
<span class="sd">        given by colon separated list in envariable BDSIMPATH, and the</span>
<span class="sd">        command line option ``packages``.</span>

<span class="sd">        The result is a dict indexed by the upper-case block name with elements:</span>
<span class="sd">        - ``path`` to the folder holding the Python file defining the block</span>
<span class="sd">        - ``classname``</span>
<span class="sd">        - ``blockname``, upper case version of ``classname``</span>
<span class="sd">        - ``url`` of online documentation for the block</span>
<span class="sd">        - ``package`` containing the block</span>
<span class="sd">        - `doc` is the docstring from the class constructor</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">parse_docstring</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
            <span class="c1"># this should have two versions: sphinx, numpy doc styles</span>
            <span class="kn">import</span> <span class="nn">re</span>
            <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

            <span class="n">re_isfield</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*:[a-zA-ZÎ±-Ï‰Î‘-Î©0-9_ ]+:&quot;</span><span class="p">)</span>
            <span class="n">re_field</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot;^\s*:(?P&lt;field&gt;[a-zA-Z]+)(?:&quot;</span>
                <span class="sa">r</span><span class="s2">&quot; +(?P&lt;var&gt;[a-zA-ZÎ±-Ï‰Î‘-Î©0-9_]+))?:(?P&lt;body&gt;.+)$&quot;</span>
            <span class="p">)</span>

            <span class="c1"># a-zA-ZÎ±-Ï‰Î‘-Î©0-9_</span>
            <span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>

            <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">)</span>
            <span class="n">excludevars</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">)</span>

            <span class="c1"># parse out all lines of the form:</span>
            <span class="c1">#</span>
            <span class="c1">#  :field var: body</span>
            <span class="c1"># or</span>
            <span class="c1">#  :field var: body with a very long description that</span>
            <span class="c1">#       carries over to another line or two</span>
            <span class="n">fieldlines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">para</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="c1"># print(para)</span>
                <span class="c1"># print(&#39;--&#39;)</span>

                <span class="n">indent_prev</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">infield</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">para</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">indent_prev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">indent_prev</span> <span class="o">=</span> <span class="n">indent</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">re_isfield</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">fieldlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
                        <span class="n">infield</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">indent</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">indent_prev</span> <span class="ow">and</span> <span class="n">infield</span><span class="p">:</span>
                        <span class="n">fieldlines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">indent</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="n">indent_prev</span><span class="p">:</span>
                        <span class="n">infield</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># fieldlines is a list of lines of the form</span>
            <span class="c1">#</span>
            <span class="c1">#   :field var: body</span>
            <span class="c1">#</span>
            <span class="c1"># where extension lines have been concatenated</span>

            <span class="c1"># create a dict of dicts</span>
            <span class="c1">#</span>
            <span class="c1">#   dict[field][var] -&gt; body</span>
            <span class="nb">dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fieldlines</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">re_field</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">field</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">excludevars</span> <span class="ow">or</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fieldnames</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">:</span>
                        <span class="nb">dict</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="p">:</span> <span class="n">body</span><span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">dict</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">body</span>
                    <span class="nb">dict</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;field&quot;</span><span class="p">)]</span>

            <span class="c1"># now connect pairs of lines of the form</span>
            <span class="c1">#</span>
            <span class="c1"># :param X: param description</span>
            <span class="c1"># :type X: type description</span>
            <span class="c1">#</span>
            <span class="c1"># params[X] = (type description, param description)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="s2">&quot;param&quot;</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">descrip</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">[</span><span class="s2">&quot;param&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">typ</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">descrip</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">params</span>

        <span class="n">block</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="s2">&quot;name, cls, path&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">toolboxes</span><span class="p">:</span>
            <span class="n">packages</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;bdsim&quot;</span><span class="p">,</span>
                <span class="s2">&quot;roboticstoolbox&quot;</span><span class="p">,</span>
                <span class="s2">&quot;machinevisiontoolbox&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">packages</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bdsim&quot;</span><span class="p">]</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BDSIMPATH&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">packages</span> <span class="o">+=</span> <span class="n">env</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">packages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">packages</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>

        <span class="n">blocks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">moduledicts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;.blocks&quot;</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="n">package</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ModuleNotFoundError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;package </span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2"> not loaded: not found, not a proper package, no blocks module&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;package </span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2"> not found or has no blocks module&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">pkg</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">load_module</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;package </span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2"> contains a compile error&quot;</span><span class="p">)</span>
                <span class="n">exc</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">fg</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">))</span>
                <span class="n">tb</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">limit</span><span class="o">=-</span><span class="mi">4</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">attr</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="c1"># except ImportError:</span>
            <span class="c1">#     print(f&quot;package {package} load error, continuing&quot;)</span>
            <span class="c1">#     import textwrap</span>

            <span class="c1">#     print(textwrap.indent(traceback.format_exc(), &quot;    &quot;))</span>
            <span class="c1">#     continue</span>

            <span class="n">moduledict</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># check if it&#39;s a valid block class</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">Block</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmro</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Block&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">blockclass</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;transfer&quot;</span><span class="p">,</span> <span class="s2">&quot;function&quot;</span><span class="p">):</span>
                    <span class="c1"># must have an output function</span>
                    <span class="n">valid</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;block </span><span class="si">{:s}</span><span class="s2"> has missing/improper output method&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">value</span><span class="o">.</span><span class="vm">__name__</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>

                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">blockclass</span> <span class="o">==</span> <span class="s2">&quot;sink&quot;</span><span class="p">:</span>
                    <span class="c1"># must have a step function with at least one</span>
                    <span class="c1"># parameter: step(self [,state])</span>
                    <span class="n">valid</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">step</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;block </span><span class="si">{:s}</span><span class="s2"> has missing/improper step method&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">value</span><span class="o">.</span><span class="vm">__name__</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>

                <span class="c1"># add it to the dict of blocks indexed by module</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="vm">__module__</span> <span class="ow">in</span> <span class="n">moduledict</span><span class="p">:</span>
                    <span class="n">moduledict</span><span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="vm">__module__</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">moduledict</span><span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="vm">__module__</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>

                <span class="c1"># create a dict for the block with metadata</span>
                <span class="n">block_info</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">block_info</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">pkg</span><span class="o">.</span><span class="n">__path__</span>
                <span class="p">)</span>  <span class="c1"># path to folder holding block definition</span>
                <span class="n">block_info</span><span class="p">[</span><span class="s2">&quot;classname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">block_info</span><span class="p">[</span><span class="s2">&quot;blockname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">blockname</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">block_info</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">pkg</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">block</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">name</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">block_info</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">block_info</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">block_info</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="vm">__module__</span>
                <span class="n">block_info</span><span class="p">[</span><span class="s2">&quot;package&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">package</span>

                <span class="c1"># get the docstring from the class and the constructor</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">+=</span> <span class="n">value</span><span class="o">.</span><span class="vm">__doc__</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">+=</span> <span class="n">value</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__doc__</span>
                <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;block has no docstring&quot;</span><span class="p">)</span>
                <span class="n">block_info</span><span class="p">[</span><span class="s2">&quot;doc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
                <span class="n">param_dict</span> <span class="o">=</span> <span class="n">parse_docstring</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                <span class="n">block_info</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_dict</span>

                <span class="c1"># now add all the other stuff we know about the block</span>
                <span class="n">block_info</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>
                <span class="n">block_info</span><span class="p">[</span><span class="s2">&quot;outputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">)</span>

                <span class="n">block_info</span><span class="p">[</span><span class="s2">&quot;nin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">nin</span>
                <span class="n">block_info</span><span class="p">[</span><span class="s2">&quot;nout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">nout</span>
                <span class="n">block_info</span><span class="p">[</span><span class="s2">&quot;blockclass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s2">&quot;block&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
                <span class="p">)</span>

                <span class="n">blocks</span><span class="p">[</span><span class="n">blockname</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">block_info</span>

            <span class="n">moduledicts</span><span class="p">[</span><span class="n">package</span><span class="p">]</span> <span class="o">=</span> <span class="n">moduledict</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">moduledicts</span> <span class="o">=</span> <span class="n">moduledicts</span>
        <span class="k">return</span> <span class="n">blocks</span></div>


<div class="viewcode-block" id="BDSim.blocks">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.blocks">[docs]</a>
    <span class="k">def</span> <span class="nf">blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List all loaded blocks.</span>

<span class="sd">        Example::</span>

<span class="sd">            73  blocks loaded</span>
<span class="sd">            bdsim.blocks.functions..................: Sum Prod Gain Clip Function Interpolate</span>
<span class="sd">            bdsim.blocks.sources....................: Constant Time WaveForm Piecewise Step Ramp</span>
<span class="sd">            bdsim.blocks.sinks......................: Print Stop Null Watch</span>
<span class="sd">            bdsim.blocks.transfers..................: Integrator PoseIntegrator LTI_SS LTI_SISO</span>
<span class="sd">            bdsim.blocks.discrete...................: ZOH DIntegrator DPoseIntegrator</span>
<span class="sd">            bdsim.blocks.linalg.....................: Inverse Transpose Norm Flatten Slice2 Slice1 Det Cond</span>
<span class="sd">            bdsim.blocks.displays...................: Scope ScopeXY ScopeXY1</span>
<span class="sd">            bdsim.blocks.connections................: Item Dict Mux DeMux Index SubSystem InPort OutPort</span>
<span class="sd">            roboticstoolbox.blocks.arm..............: FKine IKine Jacobian Tr2Delta Delta2Tr Point2Tr TR2T FDyn IDyn Gravload</span>
<span class="sd">            ........................................: Inertia Inertia_X FDyn_X ArmPlot Traj JTraj LSPB CTraj CirclePath</span>
<span class="sd">            roboticstoolbox.blocks.mobile...........: Bicycle Unicycle DiffSteer VehiclePlot</span>
<span class="sd">            roboticstoolbox.blocks.uav..............: MultiRotor MultiRotorMixer MultiRotorPlot</span>
<span class="sd">            machinevisiontoolbox.blocks.camera......: Camera Visjac_p EstPose_p ImagePlane</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">dots</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">40</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocklibrary</span><span class="p">),</span> <span class="s2">&quot; blocks loaded&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pkg</span><span class="p">,</span> <span class="nb">dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">moduledicts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">once</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="n">n</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># line will be too long</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">once</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dots</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">once</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dots</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">once</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dots</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dots</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BDSim.set_options">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.set_options">[docs]</a>
    <span class="k">def</span> <span class="nf">set_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;use sim.options.OPT=VALUE instead&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span></div>


<div class="viewcode-block" id="BDSim.set_globals">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.set_globals">[docs]</a>
    <span class="k">def</span> <span class="nf">set_globals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">globs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set globals as specified by command line</span>

<span class="sd">        :param globs: global variables</span>
<span class="sd">        :type globs: dict</span>

<span class="sd">        The command line option ``--global var=value`` can be used to request the change</span>
<span class="sd">        of global variables.  However, actually changing them requires explicit code</span>
<span class="sd">        support in the user&#39;s program after the ``BDSim`` constructor.</span>

<span class="sd">        Example::</span>

<span class="sd">            sim.set_globals(globals())</span>

<span class="sd">        Messages are displayed by defaulting, indicating which variables are changed,</span>
<span class="sd">        and their old and new values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># handle the globals</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">setglob</span><span class="p">:</span>
            <span class="n">var</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>

            <span class="n">new_value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;changed value of global </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">globs</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">new_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">globs</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span></div>


<div class="viewcode-block" id="BDSim.report">
<a class="viewcode-back" href="../../internals.html#bdsim.BDSim.report">[docs]</a>
    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print block diagram report</span>

<span class="sd">        :param bd: the block diagram to be reported</span>
<span class="sd">        :type bd: :class:`BlockDiagram`</span>
<span class="sd">        :param type: report type, one of: &quot;summary&quot; (default), &quot;lists&quot;, &quot;schedule&quot;</span>
<span class="sd">        :type type: str, optional</span>
<span class="sd">        :param style: table style, one of: ansi (default), markdown, latex</span>
<span class="sd">        :type style: str</span>

<span class="sd">        Single method wrapper for various block diagram reports.  Obeys the ``-q``</span>
<span class="sd">        option to suppress all reports at runtime.</span>

<span class="sd">        :seealso: :meth:`BlockDiagram.report_summary` :meth:`BlockDiagram.report_lists` :meth:`BlockDiagram.report_schedule`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;lists&quot;</span><span class="p">:</span>
            <span class="n">bd</span><span class="o">.</span><span class="n">report_lists</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;summary&quot;</span><span class="p">:</span>
            <span class="n">bd</span><span class="o">.</span><span class="n">report_summary</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;schedule&quot;</span><span class="p">:</span>
            <span class="n">bd</span><span class="o">.</span><span class="n">report_schedule</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</div>



<span class="k">class</span> <span class="nc">Options</span><span class="p">(</span><span class="n">OptionsBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sysargs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">default_options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;backend&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;tiles&quot;</span><span class="p">:</span> <span class="s2">&quot;3x4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;graphics&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;animation&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;hold&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;altscreen&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;simtime&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;blocks&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;outfile&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;quiet&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;setparam&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;setglob&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="c1"># modify defaults according to envariable BDSIM which is comma/semicolon</span>
        <span class="c1"># separated list of key=value pairs</span>
        <span class="c1"># eg. setenv BDSIM graphics=True,hold=True</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BDSIM&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key_value</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,;&quot;</span><span class="p">):</span>
                <span class="c1"># for each key=value pair</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">key_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)]</span>
                <span class="c1"># attempt an eval, resolves True, False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">default_options</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;envariable BDSIM, unknown option&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sysargs</span><span class="p">:</span>
            <span class="c1"># command line arguments and graphics</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
                <span class="n">prefix_chars</span><span class="o">=</span><span class="s2">&quot;-+&quot;</span><span class="p">,</span>
                <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentDefaultsHelpFormatter</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Block diagram simulation framework&quot;</span><span class="p">,</span>
                <span class="n">epilog</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;set defaults using environment variable BDSIM as a single string&quot;</span>
                    <span class="s2">&quot; containing command line options&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--backend&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-b&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;BACKEND&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;matplotlib backend to choose&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--tiles&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-t&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;ROWSxCOLS&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;window tiling as NxM&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--shape&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;WIDTHxHEIGHT&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;window size as WxH, defaults to matplotlib default&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--blocks&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span>
                <span class="n">const</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;blocks&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Display blocks at startup&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;-g&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--no-graphics&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span>
                <span class="n">const</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;graphics&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;disable graphic display, also does --no-animation&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;+g&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--graphics&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span>
                <span class="n">const</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;graphics&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;enable graphic display&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;-a&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--no-animation&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span>
                <span class="n">const</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;animation&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;do not animate graphics&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;+a&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--animation&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span>
                <span class="n">const</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;animation&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;animate graphics, also does ++graphics&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;-H&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--no-hold&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span>
                <span class="n">const</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;hold&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;do not hold graphics in done()&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;+H&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--hold&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span>
                <span class="n">const</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;hold&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;hold graphics in done()&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;+A&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--altscreen&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span>
                <span class="n">const</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;altscreen&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;display plots on second monitor&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;-A&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--no-altscreen&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span>
                <span class="n">const</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;altscreen&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;do not display plots on second monitor&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--no-progress&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-p&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span>
                <span class="n">const</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;progress&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;animate graphics&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;debug flags&quot;</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--debug&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-d&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;[psd]&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;debug flags: p/ropagate, s/tate, d/eriv, i/nteractive&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--simtime&quot;</span><span class="p">,</span> <span class="s2">&quot;-S&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;simulation time: T or T,dt&quot;</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--quiet&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-q&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span>
                <span class="n">const</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;suppress reports&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span>
                <span class="n">const</span><span class="o">=</span><span class="s2">&quot;bd.out&quot;</span><span class="p">,</span>
                <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;outfile&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;output pickled simulation results to bd.out&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--out&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;outfile&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;file to save pickled simulation results&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--set&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
                <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;setparam&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;override block parameter using block:param=value&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--global&quot;</span><span class="p">,</span>
                <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;setglob&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;override global parameter using var=value&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">args</span><span class="p">,</span> <span class="n">unknownargs</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>
            <span class="n">cmdline_options</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>  <span class="c1"># get args as a dictionary</span>
            <span class="c1"># keep only the options that are not None, ie. those that were</span>
            <span class="c1"># explicitly set on the command line</span>
            <span class="n">cmdline_options</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">option</span><span class="p">:</span> <span class="n">value</span>
                <span class="k">for</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cmdline_options</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="s2">&quot;graphics&quot;</span> <span class="ow">in</span> <span class="n">cmdline_options</span><span class="p">:</span>
                <span class="c1"># -g or +g present</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cmdline_options</span><span class="p">[</span><span class="s2">&quot;graphics&quot;</span><span class="p">]:</span>
                    <span class="c1"># -g then disable animation</span>
                    <span class="n">cmdline_options</span><span class="p">[</span><span class="s2">&quot;animation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="s2">&quot;animation&quot;</span> <span class="ow">in</span> <span class="n">cmdline_options</span> <span class="ow">and</span> <span class="n">cmdline_options</span><span class="p">[</span><span class="s2">&quot;animation&quot;</span><span class="p">]:</span>
                <span class="c1"># +a present</span>
                <span class="n">cmdline_options</span><span class="p">[</span><span class="s2">&quot;graphics&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmdline_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># empty dictionary</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="n">cmdline_options</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">default_options</span><span class="p">)</span>

        <span class="c1"># now handle the passed options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_argv</span> <span class="o">=</span> <span class="n">unknownargs</span>  <span class="c1"># save non-bdsim arguments</span>

    <span class="k">def</span> <span class="nf">sanity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="c1"># ensure graphics is enabled if animation is requested</span>
        <span class="c1"># ensure animation is disabled if graphics is disabled</span>
        <span class="k">if</span> <span class="s2">&quot;graphics&quot;</span> <span class="ow">in</span> <span class="n">options</span> <span class="ow">and</span> <span class="s2">&quot;animation&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;animation&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;graphics&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot enable animation but disable graphics&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;graphics&quot;</span> <span class="ow">in</span> <span class="n">options</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;graphics&quot;</span><span class="p">]:</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;animation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="s2">&quot;animation&quot;</span> <span class="ow">in</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;animation&quot;</span><span class="p">]:</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;graphics&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">options</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-, Peter Corke..
      <span class="lastupdated">Last updated on 06-Aug-2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-11Q6WJM565"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-11Q6WJM565', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>